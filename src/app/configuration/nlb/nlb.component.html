<h1>Server - Sync/NLB Configuration</h1>

<p>
  SapphireDb supports running in an NLB configuration/with multiple instances. The data between the different instances can be transferred
  through a webhook-like interface.
</p>

<h2>General</h2>

<p class="mb-2">
  You basically only have to configure all instances using the appsettings.json.
</p>

<app-doc [showContent]="false">
  <div lang>
    <![CDATA[
    \f:(json:appsettings.json)
    "SapphireDb": {\n
      \t"Sync": {\n
        \t\t"Enabled": true,\n\n

        \t\t// A unique id of the current instance. Will be used in nlb configurations of other instances.\n
        \t\t"Id": "nlb1"\n\n

        \t\t// Secret for current instance. Should be unique for every instance of the application. Has to be a SHA512 Hash\n
        \t\t"Secret": "77CF97E34BED553679748144E3676A95942F91EC470BBD7AD9887DC2F0BED0C53A91413F6E366AD25F037222EE4583775B8660A3E5BC72F41066E702A8989851", //= nlbSecret\n\n

        \t\t// Key for encryption of the communication. Has to be the same for all instances.\n
        \t\t"EncryptionKey": "E546C8DF278CD5931069B522E695D4F2",\n\n

        \t\t// Urls, ids and secrets of all other instances of the application\n
        \t\t"Entries": [\n
          \t\t\t{\n
            \t\t\t\t"Url": "http://localhost:5001",\n
            \t\t\t\t"Secret": "nlbSecret"\n
            \t\t\t\t"Id": "nlb2"\n
          \t\t\t},\n
          \t\t\t{\n
            \t\t\t\t"Url": "http://localhost:5002",\n
            \t\t\t\t"Secret": "nlbSecret"\n
            \t\t\t\t"Id": "nlb3"\n
          \t\t\t}\n
        \t\t]\n
      \t}\n
    },
    ]]>
  </div>
</app-doc>

<h2>Propagate external change</h2>

<p>
  You can also use the feature described above to send changes from an external source (for example if you changed something in the database directly) to the instances of SapphireDb.<br>
  A request to the server should look like this:
</p>

<app-doc [showContent]="false">
  <div lang>
    <![CDATA[
    \f:(json:request)\n
    POST http://localhost:5000/sapphire/sync/message?propagate=true\n
    Accept: */*\n
    Cache-Control: no-cache\n
    Secret: nlbSecret\n
    OriginId: nlb2\n\n

    {\n
      \t"message": "test123456"\n
    }\n\n

    ###
    ]]>
  </div>
</app-doc>

<div class="remark info">
  Note the query parameter <code>propagate=true</code>. This will tell the one instance you call to propagate the changes to the other instances of SapphireDb.
</div>
